<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Sapphire Dark Blue Canvas</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>

        /* Import Inter and Nunito Sans fonts */

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito+Sans:wght@200;300;400&display=swap');

        body {

            font-family: 'Inter', sans-serif;

        }

        .nunito-sans {

            font-family: 'Nunito Sans', sans-serif;

        }

        /* Custom class for Royal Turquoise color */

        .text-royal-turquoise {

            color: #40E0D0; /* Turquoise color */

        }

        /* Custom scrollbar styles */

        .custom-scrollbar::-webkit-scrollbar {

            width: 8px;

        }

        .custom-scrollbar::-webkit-scrollbar-track {

            background: rgba(255, 255, 255, 0.05);

            border-radius: 10px;

        }

        .custom-scrollbar::-webkit-scrollbar-thumb {

            background: rgba(255, 255, 255, 0.2);

            border-radius: 10px;

        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {

            background: rgba(255, 255, 255, 0.3);

        }



        /* Neomorfik Button Style */

        .neumorphic-button {

            background: linear-gradient(145deg, #2a3a6a, #233054); /* Dark blue tones gradient */

            /* Inset shadows only (indented appearance) */

            box-shadow: inset 5px 5px 10px #1e2844,    /* Dark shadow for indented effect */

                        inset -5px -5px 10px #30447a;  /* Light shadow for indented effect */

            border-radius: 12px; /* Soft corners */

            transition: all 0.3s ease; /* Transition effect */

            border: 1px solid rgba(64, 224, 208, 0.3); /* Thin royal turquoise border */

        }



        .neumorphic-button:hover {

            /* No outer shadow on hover, just slight scaling and gradient change */

            transform: scale(0.98); /* Slight shrink effect */

            background: linear-gradient(145deg, #233054, #2a3a6a); /* Background inversion for pressed look */

            box-shadow: inset 3px 3px 6px #1e2844, inset -3px -3px 6px #30447a; /* Slightly less prominent inner shadow */

        }



        /* New Loading Animation */

        .premium-loader {

            width: 60px;

            height: 60px;

            border-radius: 50%;

            background: radial-gradient(circle at 30% 30%, #40E0D0, #00174C); /* Royal turquoise to dark blue gradient */

            animation: pulse 1.5s infinite ease-in-out;

            position: relative;

            display: flex;

            align-items: center;

            justify-content: center;

        }



        .premium-loader::before {

            content: '';

            position: absolute;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            border-radius: 50%;

            box-shadow: 0 0 15px 5px rgba(64, 224, 208, 0.7); /* Soft turquoise glow */

            animation: glow 1.5s infinite ease-in-out;

        }



        @keyframes pulse {

            0% { transform: scale(0.8); opacity: 0.7; }

            50% { transform: scale(1.1); opacity: 1; }

            100% { transform: scale(0.8); opacity: 0.7; }

        }



        @keyframes glow {

            0% { box-shadow: 0 0 5px 2px rgba(64, 224, 208, 0.4); }

            50% { box-shadow: 0 0 20px 8px rgba(64, 224, 208, 0.9); }

            100% { box-shadow: 0 0 5px 2px rgba(64, 224, 208, 0.4); }

        }



        /* Canvas's Background */

        body {

            background-color: #00174C; /* Solid color #00174C used */

            color: #FFFFFF; /* Default text color for dark mode */

            min-height: 100vh;

            display: flex;

            flex-direction: column;

            align-items: center;

            padding: 1rem;

            position: relative; /* For pseudo-element positioning */

        }



        /* Filigree Screen Protector Effect */

        body::before {

            content: '';

            position: absolute;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M25 0V25H0V75H25V100H75V75H100V25H75V0H25Z' fill='%23ffffff' opacity='0.05'/%3E%3C/svg%3E");

            background-size: 200px 200px; /* Adjust pattern size */

            opacity: 0.01; /* Even more subtle */

            pointer-events: none; /* Allow clicks through */

            z-index: -2; /* Keep it in the background */

        }



        /* Blue Light Filter Overlay */

        body::after {

            content: '';

            position: absolute;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background-color: rgba(255, 200, 0, 0.01); /* Very subtle warm tint (yellow/orange) */

            pointer-events: none;

            z-index: -1; /* Keep it in the background, above the filigree */

        }



        /* Day Mode styles */

        body.day-mode {

            background-color: #F0F4F8; /* Light background for day mode */

            color: #333333; /* Darker text color for day mode */

        }



        body.day-mode .text-royal-turquoise {

            color: #00796B; /* Darker turquoise for day mode */

        }



        body.day-mode .text-gray-300 {

            color: #666666; /* Darker gray for day mode */

        }



        body.day-mode .text-gray-400 {

            color: #888888; /* Darker gray for day mode */

        }



        body.day-mode .bg-opacity-5 {

            background-color: rgba(0, 0, 0, 0.05); /* Slightly darker transparent for light mode */

        }



        body.day-mode .bg-opacity-10 {

            background-color: rgba(0, 0, 0, 0.1); /* Slightly darker transparent for light mode */

        }



        body.day-mode .neumorphic-button {

            background: linear-gradient(145deg, #e0e6ec, #f8fcff); /* Light neumorphic gradient */

            box-shadow: 5px 5px 10px #d0d5da, -5px -5px 10px #ffffff;

            border-color: rgba(0, 121, 107, 0.3); /* Darker turquoise border */

        }



        body.day-mode .neumorphic-button:hover {

            background: linear-gradient(145deg, #f8fcff, #e0e6ec);

            box-shadow: inset 3px 3px 6px #d0d5da, inset -3px -3px 6px #ffffff;

        }



        /* Adjust filigree and blue light filter for day mode */

        body.day-mode::before {

            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M25 0V25H0V75H25V100H75V75H100V25H75V0H25Z' fill='%23000000' opacity='0.05'/%3E%3C/svg%3E"); /* Darker pattern for light mode */

            opacity: 0.01;

        }



        body.day-mode::after {

            background-color: rgba(0, 0, 0, 0.005); /* Even more subtle for day mode */

        }



        /* Realestate. brand color for day mode */

        body.day-mode #realestate-brand {

            color: #1A054F; /* Dark purple/blue for day mode */

        }



        /* Day mode input text and placeholder colors */

        body.day-mode #chat-input,

        body.day-mode #tool-chat-input {

            color: #333333; /* Dark gray text for day mode */

        }



        body.day-mode #chat-input::placeholder,

        body.day-mode #tool-chat-input::placeholder {

            color: #999999; /* Medium gray placeholder for day mode */

        }

    </style>

</head>

<body class="min-h-screen flex flex-col items-center p-4">



    <button id="theme-toggle-button" class="fixed bottom-4 left-4 z-50 p-2 bg-white bg-opacity-10 text-royal-turquoise rounded-full hover:bg-opacity-20 transition-colors duration-200 w-8 h-8 flex items-center justify-center">

        <svg id="theme-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

            <path d=""/>

        </svg>

    </button>



    <button id="user-icon-button" class="fixed top-4 right-4 z-50 p-2 bg-white bg-opacity-10 text-royal-turquoise rounded-full hover:bg-opacity-20 transition-colors duration-200">

        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>

        </svg>

    </button>



    <header class="w-full max-w-7xl flex flex-col items-center py-4 px-6 mb-8">

        <div class="text-center mb-4">

            <h1 class="text-3xl md:text-4xl font-extrabold text-white leading-tight"><span id="realestate-brand">Realestate.</span><span class="text-royal-turquoise nunito-sans font-light">Web4</span></h1>

            <p class="text-royal-turquoise nunito-sans font-light text-sm md:text-base tracking-wide mt-1">Smart Digital Industry Mall for Real Estate</p>

        </div>



        </header>



    <main class="flex-grow w-full max-w-7xl flex flex-col items-center">

        <div id="search-section" class="w-full max-w-xl mx-auto my-8 p-2 bg-white bg-opacity-5 rounded-lg shadow-lg flex flex-col items-center border border-royal-turquoise border-opacity-20">

            <div class="flex w-full items-center">

                <button id="microphone-button" class="p-2 text-royal-turquoise hover:text-white transition-colors duration-200">

                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 10v2a7 7 0 01-14 0v-2"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19v4"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 23h8"></path>

                    </svg>

                </button>

                <input type="text" id="search-input" placeholder="Smart Search with NLWorld AI..." class="flex-grow p-2 bg-transparent text-gray-300 placeholder-gray-400 focus:outline-none text-sm md:text-base">

                <button id="search-button" class="ml-2 p-2 bg-royal-turquoise text-blue-950 rounded-md font-semibold text-sm md:text-base hover:bg-opacity-80 transition-colors duration-200 flex items-center justify-center">

                    <svg class="w-5 h-5 text-royal-turquoise" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>

                    </svg>

                </button>

            </div>



            <div id="suggestion-buttons" class="w-full flex flex-wrap justify-center gap-x-3 gap-y-2 mt-4">

                </div>

        </div>



        <div id="promotion-tags-section" class="w-full max-w-xl mx-auto my-8 p-2 bg-white bg-opacity-5 rounded-lg shadow-lg flex flex-wrap justify-center gap-x-3 gap-y-2 border border-royal-turquoise border-opacity-20">

            </div>



        <div id="loading-indicator" class="hidden text-white mt-4 flex flex-col items-center">

            <div class="premium-loader"></div>

            <p class="text-center mt-2 nunito-sans font-light text-sm">Loading...</p>

        </div>



        <div id="search-results-container" class="w-full max-w-xl mx-auto mt-8 p-4 bg-white bg-opacity-5 rounded-lg shadow-lg flex flex-col border border-royal-turquoise border-opacity-20 custom-scrollbar">

            <div class="flex justify-between items-center mb-4">

                <h2 class="text-royal-turquoise text-sm nunito-sans font-light"></h2>

            </div>

            <div id="search-results-list" class="flex flex-col gap-4">

                <p class="text-gray-400 text-center nunito-sans font-light text-sm">Web4. Search results will be listed here.</p>

            </div>

            <button id="load-more-button" class="hidden mt-6 p-2 bg-white bg-opacity-10 text-royal-turquoise rounded-md nunito-sans font-light text-xs hover:bg-opacity-20 transition-colors duration-200">

                Load More

            </button>

            <button id="clear-results-button" class="mt-2 p-2 bg-white bg-opacity-10 rounded-md hover:bg-opacity-20 transition-colors duration-200 flex items-center justify-center">

                <svg class="w-5 h-5 text-white opacity-50 hover:opacity-100 transition-opacity duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>

                </svg>

                <span class="ml-2 text-sm text-gray-400 nunito-sans font-light">Clear Results</span>

            </button>

            </div>



        <div id="tool-chat-container" class="hidden w-full max-w-xl mx-auto mt-8 p-4 bg-white bg-opacity-5 rounded-lg shadow-lg flex flex-col border border-royal-turquoise border-opacity-20">

            <h2 id="tool-chat-title" class="text-royal-turquoise text-xl font-semibold mb-4"></h2>

            <div id="tool-chat-messages" class="flex-grow overflow-y-auto h-64 mb-4 p-2 rounded-md bg-white bg-opacity-10 text-gray-300 custom-scrollbar">

                </div>

            <div class="flex">

                <input type="text" id="tool-chat-input" placeholder="Ask about this tool..." class="flex-grow p-2 bg-transparent text-white placeholder-gray-400 focus:outline-none text-sm md:text-base nunito-sans font-light border border-white border-opacity-20 rounded-md">

                <button id="microphone-tool-chat-button" class="ml-2 p-2 bg-white bg-opacity-10 rounded-md font-semibold text-sm md:text-base hover:bg-opacity-20 transition-colors duration-200 flex items-center justify-center">

                    <svg class="w-5 h-5 text-royal-turquoise" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 10v2a7 7 0 01-14 0v-2"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19v4"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 23h8"></path>

                    </svg>

                </button>

                <button id="send-tool-chat-button" class="ml-2 p-2 bg-white bg-opacity-10 rounded-md font-semibold text-sm md:text-base hover:bg-opacity-20 transition-colors duration-200 flex items-center justify-center">

                    <svg class="w-5 h-5 text-royal-turquoise" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>

                    </svg>

                </button>

            </div>

            <button id="back-to-search-from-tool-chat" class="mt-4 p-2 bg-white bg-opacity-10 text-royal-turquoise rounded-md nunito-sans font-light text-sm hover:bg-opacity-20 transition-colors duration-200">

                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>

                </svg>

                Back to Search

            </button>

        </div>



        <div id="chat-container" class="hidden w-full max-w-xl mx-auto mt-8 p-4 bg-white bg-opacity-5 rounded-lg shadow-lg flex flex-col border border-royal-turquoise border-opacity-20">

            <h2 id="url-chat-title" class="text-royal-turquoise text-xl font-semibold mb-4"></h2>

            <div id="chat-messages" class="flex-grow overflow-y-auto h-64 mb-4 p-2 rounded-md bg-white bg-opacity-10 text-gray-300 custom-scrollbar">

                </div>

            <div class="flex">

                <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow p-2 bg-transparent text-white placeholder-gray-400 focus:outline-none text-sm md:text-base nunito-sans font-light">

                <button id="microphone-chat-button" class="ml-2 p-2 bg-white bg-opacity-10 rounded-md font-semibold text-sm md:text-base hover:bg-opacity-20 transition-colors duration-200 flex items-center justify-center">

                    <svg class="w-5 h-5 text-royal-turquoise" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 10v2a7 7 0 01-14 0v-2"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19v4"></path>

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 23h8"></path>

                    </svg>

                </button>

                <button id="send-chat-button" class="ml-2 p-2 bg-white bg-opacity-10 rounded-md font-semibold text-sm md:text-base hover:bg-opacity-20 transition-colors duration-200 flex items-center justify-center">

                    <svg class="w-5 h-5 text-royal-turquoise" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>

                    </svg>

                </button>

            </div>

            <button id="back-to-search-from-chat" class="mt-4 p-2 bg-white bg-opacity-10 text-royal-turquoise rounded-md nunito-sans font-light text-sm hover:bg-opacity-20 transition-colors duration-200">

                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>

                </svg>

                Back to Search

            </button>

        </div>

    </main>



    <a href="https://www.realestate.web4.com" target="_blank" id="discovery-link" 

       class="mt-8 px-6 py-3 text-royal-turquoise font-semibold nunito-sans text-base md:text-lg neumorphic-button">

        Discovery Realestate.Web4

    </a>



    <footer class="w-full text-center py-4 mt-2">

        <p class="text-royal-turquoise nunito-sans font-light text-xs">Power by Web4.0 os Platform WY</p>

    </footer>



    <script type="module">
        (function() { // All script content is wrapped in an IIFE
        
            // Check if the script has already been initialized
            if (window.myAppInitialized) {
                console.log("Script already initialized, skipping re-execution.");
                return;
            }
            window.myAppInitialized = true;
        
            // API KEYS & ENDPOINTS
            const GOOGLE_API_KEY = "AIzaSyCq9FqMZsZWKUVUno6UbUlU-ebLielup7A";
            const GOOGLE_CX = "151a3889deeac47b9";
            const GPT_API_KEY = "11x9IG7HZkyphyxj7I41UPWOshDNpWJAvUdiuUeVoxnMy6CPsY5cJQQJ99BDACYeBjFXJ3w3AAAAACOGQMYE";
            const GPT_API_URL = "https://ai-gptai749384661431.openai.azure.com/openai/deployments/gpt-4.1-mini/chat/completions?api-version=2025-01-01-preview";
            const NLWEB_ANALYTICS_KEY = "2dv6SQUJoCgsZuu1G3YCz5nkcGdzqMWYj7WLici2pLgzMWPJhCBlJQQJ99BEACYeBjFXJ3w3AAAEACOGPvoX";
            const NLWEB_ANALYTICS_ENDPOINT = "https://nlweb.cognitiveservices.azure.com/";
        
            // UI Elements
            const userIconButton = document.getElementById('user-icon-button'); 
            const discoveryLink = document.getElementById('discovery-link');
        
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const microphoneButton = document.getElementById('microphone-button');
            const suggestionButtonsContainer = document.getElementById('suggestion-buttons');
            const promotionTagsSection = document.getElementById('promotion-tags-section'); // New promotion section
            const loadingIndicator = document.getElementById('loading-indicator');
            const searchSection = document.getElementById('search-section');
            const searchResultsContainer = document.getElementById('search-results-container');
            const searchResultsList = document.getElementById('search-results-list');
            const loadMoreButton = document.getElementById('load-more-button');
            const clearResultsButton = document.getElementById('clear-results-button');
            const chatContainer = document.getElementById('chat-container');
            const urlChatTitle = document.getElementById('url-chat-title'); // Reference to URL chat title
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChatButton = document.getElementById('send-chat-button');
            const microphoneChatButton = document.getElementById('microphone-chat-button'); // New microphone button for URL chat
            const backToSearchFromChatButton = document.getElementById('back-to-search-from-chat');
        
            // Tool Chat Elements
            const toolChatContainer = document.getElementById('tool-chat-container');
            const toolChatTitle = document.getElementById('tool-chat-title');
            const toolChatMessages = document.getElementById('tool-chat-messages');
            const toolChatInput = document.getElementById('tool-chat-input');
            const sendToolChatButton = document.getElementById('send-tool-chat-button');
            const microphoneToolChatButton = document.getElementById('microphone-tool-chat-button');
            const backToSearchFromToolChatButton = document.getElementById('back-to-search-from-tool-chat');
        
            let currentChatHistory = []; // For URL chat
            let currentChatURL = ''; 
            let currentToolChatHistory = []; // For Tool chat
            let currentToolName = ''; // Name of the tool being chatted about
        
            // Search and pagination state
            let resultsPerPage = 5;
            let maxResults = 30;
            let currentSearchQuery = '';
            let currentResultsDisplayed = 0;
        
            // Predefined search suggestions - Real estate sector tags
            const realEstateTags = [
                "For Sale", "For Rent", "Residential", "Apartment", "Land", "Villa", "Office", "Project", "Company", "Real Estate Agent"
            ];
        
            // Web4 Promotional Tags
            const web4PromotionTags = [
                "uWeb4", "AI.Tools", "Marketplace", "DigitalTwin", "IoT"
            ];
        
            function createSuggestionButtons() {
                suggestionButtonsContainer.innerHTML = '';
                realEstateTags.forEach(tag => {
                    const button = document.createElement('button');
                    button.textContent = tag;
                    button.className = 'px-3 py-1 bg-white bg-opacity-10 text-royal-turquoise rounded-full text-xs hover:bg-opacity-20 transition-colors duration-200 flex-shrink-0';
                    button.addEventListener('click', () => {
                        const currentInputValue = searchInput.value.trim();
                        searchInput.value = currentInputValue ? `${currentInputValue} ${tag}` : tag;
                        performSearch();
                    });
                    suggestionButtonsContainer.appendChild(button);
                });
            }
        
            function createPromotionTags() {
                if (promotionTagsSection) {
                    promotionTagsSection.innerHTML = '';
                    web4PromotionTags.forEach(tag => {
                        const button = document.createElement('button');
                        button.textContent = tag;
                        button.className = 'px-3 py-1 bg-white bg-opacity-10 text-royal-turquoise rounded-full text-xs hover:bg-opacity-20 transition-colors duration-200 flex-shrink-0';
                        button.addEventListener('click', () => {
                            startToolChat(tag);
                        });
                        promotionTagsSection.appendChild(button);
                    });
                }
            }
        
            async function performSearch() {
                const query = searchInput.value.trim();
                if (!query) return;
        
                if (query !== currentSearchQuery) {
                    currentSearchQuery = query;
                    currentResultsDisplayed = 0;
                    searchResultsList.innerHTML = '';
                    loadMoreButton.classList.add('hidden');
                }
        
                showLoading(true);
                searchSection.classList.remove('hidden');
                searchResultsContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                toolChatContainer.classList.add('hidden');
                currentChatHistory = [];
                currentToolChatHistory = [];
        
                try {
                    const newResults = await realGoogleSearch(query, currentResultsDisplayed + resultsPerPage);
                    const aiContextualResults = await aiContextualizeSearchResults(query, newResults);
        
                    displaySearchResults(aiContextualResults);
                    currentResultsDisplayed += aiContextualResults.length;
        
                    if (currentResultsDisplayed < maxResults && aiContextualResults.length > 0) {
                        loadMoreButton.classList.remove('hidden');
                    } else {
                        loadMoreButton.classList.add('hidden');
                    }
        
                } catch (error) {
                    console.error("Search error:", error);
                    alert("An error occurred during search. Please try again.");
                } finally {
                    showLoading(false);
                }
            }
        
            // REAL Google Custom Search API
            async function realGoogleSearch(query, limit) {
                const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(query)}&key=${GOOGLE_API_KEY}&cx=${GOOGLE_CX}&num=${resultsPerPage}&start=${currentResultsDisplayed+1}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Google Search API error");
                const data = await resp.json();
                const items = data.items || [];
                return items.map(item => ({
                    title: item.title,
                    url: item.link,
                    snippet: item.snippet
                }));
            }
        
            // Use GPT-4.1 Mini for contextualizing search results (AI summary)
            async function aiContextualizeSearchResults(query, googleResults) {
                // Prepare a prompt for chat/completions
                const messages = [
                    { role: "system", content: "You are nlweb, a helpful AI assistant for real estate and technology search." },
                    { role: "user", content: `These are the search results for the query "${query}":\n\n${googleResults.map((r, i) => `${i+1}. ${r.title}\n${r.snippet}\nURL: ${r.url}`).join('\n\n')}\n\nFor each result, give a 1-sentence insight or contextual information about why this result might be useful.` }
                ];
        
                const aiOutput = await gptChat(messages);
        
                // Try to distribute AI's output as gemini_insight style over results (simple split or assign to all)
                let insights = [];
                if (aiOutput) {
                    insights = aiOutput.split('\n').filter(Boolean);
                }
                return googleResults.map((result, i) => ({
                    ...result,
                    gemini_insight: insights[i] || insights[0] || 'nlweb: Detaylı bilgi için sonucu inceleyin.'
                }));
            }
        
            // GPT-4.1 Mini chat completion
            async function gptChat(messages) {
                const body = {
                    messages,
                    max_tokens: 512,
                    temperature: 0.7,
                    top_p: 1,
                    frequency_penalty: 0,
                    presence_penalty: 0
                };
                const response = await fetch(GPT_API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "api-key": GPT_API_KEY
                    },
                    body: JSON.stringify(body)
                });
                if (!response.ok) throw new Error("GPT API error");
                const data = await response.json();
                return data.choices?.[0]?.message?.content || '';
            }
        
            function displaySearchResults(results) {
                if (currentResultsDisplayed === 0) {
                    searchResultsList.innerHTML = '';
                }
                if (results.length === 0 && currentResultsDisplayed === 0) {
                    searchResultsList.innerHTML = '<p class="text-gray-400 text-center nunito-sans font-light text-sm">Web4. Search results will be listed here.</p>';
                    return;
                }
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'bg-white bg-opacity-10 p-4 rounded-md border border-white border-opacity-20 flex flex-col';
        
                    const title = document.createElement('h3');
                    title.className = 'text-white text-md font-semibold cursor-pointer hover:underline';
                    title.textContent = result.title;
                    title.addEventListener('click', () => window.open(result.url, '_blank'));
        
                    const url = document.createElement('p');
                    url.className = 'text-royal-turquoise text-sm mt-1';
                    url.textContent = result.url;
        
                    const snippet = document.createElement('p');
                    snippet.className = 'text-gray-300 text-sm mt-2';
                    snippet.textContent = result.snippet;
        
                    const insight = document.createElement('div');
                    insight.className = 'text-xs text-emerald-300 mt-2';
                    insight.textContent = result.gemini_insight;
        
                    const chatButton = document.createElement('button');
                    chatButton.className = 'mt-3 p-2 bg-white bg-opacity-10 text-royal-turquoise rounded-md font-semibold text-xs hover:bg-opacity-20 transition-colors duration-200';
                    chatButton.textContent = 'Web4.AI';
                    chatButton.addEventListener('click', () => {
                        console.log("Web4.AI button clicked for URL:", result.url);
                        startChatWithURL(result.url);
                    });
        
                    resultItem.appendChild(title);
                    resultItem.appendChild(url);
                    resultItem.appendChild(snippet);
                    resultItem.appendChild(insight);
                    resultItem.appendChild(chatButton);
                    searchResultsList.appendChild(resultItem);
                });
            }
        
            // ----------- CHAT FUNCTIONS (USE GPT API) ------------
        
            async function startChatWithURL(url) {
                console.log("Entering startChatWithURL for:", url);
                currentChatURL = url;
                currentChatHistory = [];
                chatMessages.innerHTML = '';
                urlChatTitle.textContent = `Chat about: ${url.substring(0, 50)}...`; // Set URL chat title
        
                searchSection.classList.add('hidden');
                searchResultsContainer.classList.add('hidden');
                promotionTagsSection.classList.add('hidden');
                toolChatContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
        
                addChatMessage('model', 'nlweb: Analyzing website content...');
                const initialSummary = await aiChatResponse('summarize_url_content', currentChatURL, []);
                addChatMessage('model', initialSummary);
                currentChatHistory.push({ role: 'model', content: initialSummary });
            }
        
            async function startToolChat(toolName) {
                console.log("Entering startToolChat for:", toolName);
                currentToolName = toolName;
                currentToolChatHistory = [];
                toolChatMessages.innerHTML = '';
                toolChatTitle.textContent = `Copilot for ${toolName}`;
        
                searchSection.classList.add('hidden');
                searchResultsContainer.classList.add('hidden');
                promotionTagsSection.classList.add('hidden');
                chatContainer.classList.add('hidden');
                toolChatContainer.classList.remove('hidden');
        
                addToolChatMessage('model', `nlweb: Analyzing detailed information about ${toolName}...`);
                const initialSummary = await aiChatResponse('summarize_tool_content', toolName, [], true);
                addToolChatMessage('model', initialSummary);
                currentToolChatHistory.push({ role: 'model', content: initialSummary });
            }
        
            function addChatMessage(role, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-2 rounded-md ${role === 'user' ? 'bg-royal-turquoise text-royal-turquoise self-end nunito-sans font-light text-sm' : 'bg-white bg-opacity-10 text-gray-300 self-start nunito-sans font-light text-sm'}`;
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        
            function addToolChatMessage(role, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-2 rounded-md ${role === 'user' ? 'bg-royal-turquoise text-royal-turquoise self-end nunito-sans font-light text-sm' : 'bg-white bg-opacity-10 text-gray-300 self-start nunito-sans font-light text-sm'}`;
                messageDiv.textContent = text;
                toolChatMessages.appendChild(messageDiv);
                toolChatMessages.scrollTop = toolChatMessages.scrollHeight;
            }
        
            async function sendChatMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
        
                addChatMessage('user', message);
                chatInput.value = '';
                currentChatHistory.push({ role: 'user', content: message });
        
                const aiResponse = await aiChatResponse(message, currentChatURL, currentChatHistory);
                addChatMessage('model', aiResponse);
                currentChatHistory.push({ role: 'model', content: aiResponse });
            }
        
            async function sendToolChatMessage() {
                const message = toolChatInput.value.trim();
                if (!message) return;
        
                addToolChatMessage('user', message);
                toolChatInput.value = '';
                currentToolChatHistory.push({ role: 'user', content: message });
        
                const aiResponse = await aiChatResponse(message, currentToolName, currentToolChatHistory, true);
                addToolChatMessage('model', aiResponse);
                currentToolChatHistory.push({ role: 'model', content: aiResponse });
            }
        
            // AI chat response using GPT-4.1 Mini (nlweb persona)
            async function aiChatResponse(userMessage, context, history, isToolChat = false) {
                // Prepare messages for context and chat
                let starter = isToolChat
                    ? { role: "system", content: `You are nlweb, a helpful AI assistant for Web4 tools. Tool: ${context}` }
                    : { role: "system", content: `You are nlweb, a helpful AI assistant for web search and real estate. URL: ${context}` };
                let msgs = [starter, ...history.filter(m => m.role && m.content).map(m => ({ role: m.role === "user" ? "user" : "assistant", content: m.content }))];
        
                // If first message is a summary request
                if (userMessage === 'summarize_url_content') {
                    msgs.push({ role: "user", content: "Summarize the main topic, key features and important information about this website. Reply in Turkish." });
                } else if (userMessage === 'summarize_tool_content') {
                    msgs.push({ role: "user", content: "Summarize the tool, its main features, pricing, usage, and benefits. Reply in Turkish." });
                } else {
                    msgs.push({ role: "user", content: userMessage });
                }
                return await gptChat(msgs);
            }
        
            // Loading indicator
            function showLoading(show) {
                if (show) {
                    loadingIndicator.classList.remove('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                }
            }
        
            // Event Listeners
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            sendChatButton.addEventListener('click', sendChatMessage); 
            microphoneChatButton.addEventListener('click', () => {
                alert("Microphone feature will be added for URL chat. Browser voice input permission may be required.");
            });
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            sendToolChatButton.addEventListener('click', sendToolChatMessage); 
            microphoneToolChatButton.addEventListener('click', () => {
                alert("Microphone feature will be added for Tool chat. Browser voice input permission may be required.");
            });
            toolChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendToolChatMessage();
                }
            });
            loadMoreButton.addEventListener('click', performSearch);
            clearResultsButton.addEventListener('click', () => {
                searchResultsList.innerHTML = '<p class="text-gray-400 text-center nunito-sans font-light text-sm">Web4. Search results will be listed here.</p>';
                loadMoreButton.classList.add('hidden');
                currentResultsDisplayed = 0;
                currentSearchQuery = '';
                searchInput.value = '';
            });
            backToSearchFromChatButton.addEventListener('click', () => {
                chatContainer.classList.add('hidden');
                searchSection.classList.remove('hidden');
                searchResultsContainer.classList.remove('hidden');
                promotionTagsSection.classList.remove('hidden');
                currentChatHistory = [];
                currentChatURL = '';
            });
            backToSearchFromToolChatButton.addEventListener('click', () => {
                toolChatContainer.classList.add('hidden');
                searchSection.classList.remove('hidden');
                searchResultsContainer.classList.remove('hidden');
                promotionTagsSection.classList.remove('hidden');
                currentToolChatHistory = [];
                currentToolName = '';
            });
        
            document.addEventListener('DOMContentLoaded', createSuggestionButtons);
            document.addEventListener('DOMContentLoaded', createPromotionTags);
        
            microphoneButton.addEventListener('click', () => {
                alert("Microphone feature will be added. Browser voice input permission may be required.");
            });
        
            // Theme Toggle Logic
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const themeIcon = document.getElementById('theme-icon');
            let isDayMode = false; // Start in night mode (dark theme)
            const sunPath = "M12 1a11 11 0 100 22 11 11 0 000-22zm0 20a9 9 0 110-18 9 9 0 010 18zM12 6v-2h0v2zm0 12v-2h0v2zm6-6h2h-2zm-12 0h2h-2zm10.2-5.2l-1.4-1.4-1.4 1.4 1.4 1.4zm-8.8 8.8l-1.4-1.4-1.4 1.4 1.4 1.4zm0-8.8l1.4-1.4 1.4 1.4-1.4 1.4zm8.8 0l1.4 1.4 1.4-1.4-1.4-1.4z";
            const moonPath = "M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.37A9 9 0 0112 3z";
            themeIcon.setAttribute('d', moonPath);
        
            themeToggleButton.addEventListener('click', () => {
                isDayMode = !isDayMode;
                if (isDayMode) {
                    document.body.classList.add('day-mode');
                    themeIcon.setAttribute('d', sunPath);
                    console.log("Switched to Day Mode");
                } else {
                    document.body.classList.remove('day-mode');
                    themeIcon.setAttribute('d', moonPath);
                    console.log("Switched to Night Mode");
                }
            });
        
        })(); // End of IIFE
        </script>

</body>

</html>

